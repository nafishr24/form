<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Formulir Lomba</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 700px;
      margin: 20px auto;
      background: #f5f7fa;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 0 15px rgba(0,0,0,0.1);
    }
    h2 {
      text-align: center;
      color: #333;
    }
    /* Tambahkan di bagian <style> */
    select {
    width: 100%;
    padding: 8px;
    margin-top: 4px;
    box-sizing: border-box;
    border: 1px solid #ccc;
    border-radius: 5px;
    font-size: 14px;
    background-color: white;
    }

    select:focus {
    border-color: #007bff;
    outline: none;
    }
    label {
      display: block;
      margin-top: 10px;
      font-weight: bold;
      color: #555;
    }
    input[type=text], input[type=date] {
      width: 100%;
      padding: 8px;
      margin-top: 4px;
      box-sizing: border-box;
      border: 1px solid #ccc;
      border-radius: 5px;
      font-size: 14px;
      transition: border-color 0.3s;
    }
    input[type=text]:focus, input[type=date]:focus {
      border-color: #007bff;
      outline: none;
    }
    button, input[type=submit] {
      cursor: pointer;
      background-color: #007bff;
      border: none;
      color: white;
      padding: 10px 18px;
      margin-top: 15px;
      border-radius: 5px;
      font-size: 15px;
      transition: background-color 0.3s;
    }
    button:hover, input[type=submit]:hover {
      background-color: #0056b3;
    }
    .peserta-section {
      background: white;
      border: 1px solid #ddd;
      padding: 15px;
      margin-top: 15px;
      border-radius: 8px;
      position: relative;
    }
    .remove-btn {
      position: absolute;
      right: 15px;
      top: 15px;
      background-color: #dc3545;
      border: none;
      color: white;
      padding: 5px 10px;
      border-radius: 5px;
      font-size: 13px;
    }
    .remove-btn:hover {
      background-color: #a71d2a;
    }

    /* Toast Notification */
    #toast {
      visibility: hidden;
      min-width: 250px;
      margin-left: -125px;
      background-color: #333;
      color: #fff;
      text-align: center;
      border-radius: 8px;
      padding: 15px;
      position: fixed;
      z-index: 9999;
      left: 50%;
      bottom: 30px;
      font-size: 17px;
      opacity: 0;
      transition: opacity 0.5s ease-in-out, visibility 0.5s;
    }
    #toast.show {
      visibility: visible;
      opacity: 1;
      animation: fadeinout 3s forwards;
    }
    @keyframes fadeinout {
      0% {bottom: 0; opacity: 0;}
      10% {bottom: 30px; opacity: 1;}
      90% {bottom: 30px; opacity: 1;}
      100% {bottom: 0; opacity: 0;}
    }

    /* Autocomplete dropdown */
    .autocomplete-items {
      position: absolute;
      border: 1px solid #d4d4d4;
      border-bottom: none;
      border-top: none;
      z-index: 99;
      top: 100%;
      left: 0;
      right: 0;
      max-height: 150px;
      overflow-y: auto;
      background-color: white;
      border-radius: 0 0 5px 5px;
    }
    .autocomplete-items div {
      padding: 10px;
      cursor: pointer;
      border-bottom: 1px solid #d4d4d4;
    }
    .autocomplete-items div:hover {
      background-color: #e9e9e9;
    }
  </style>
</head>
<body>
  <h2>Formulir Pendaftaran Lomba</h2>
  <form id="contestForm" autocomplete="off">
    <label for="nama_pendamping">Nama Pendamping:</label>
    <input type="text" name="nama_pendamping" id="nama_pendamping" required>

    <label for="kontak_pendamping">Kontak Pendamping:</label>
    <input type="text" name="kontak_pendamping" id="kontak_pendamping" required>

    <label for="rayon">Rayon:</label>
    <select name="rayon" id="rayon" required>
        <option value="">Pilih Rayon</option>
        <option value="Rayon 1 - Universitas Madura">Rayon 1 - Universitas Madura</option>
        <option value="SMKN 2 Sampang">Rayon 2 - SMKN 2 Sampang</option>
        <option value="Rayon 3 - SMKN 1 Sumenep">Rayon 3 - SMKN 1 Sumenep</option>
        <option value="Rayon 4 - SMKN 1 Bangkalan">Rayon 4 - SMKN 1 Bangkalan</option>
    </select>

    <div id="pesertaContainer"></div>

    <button type="button" onclick="addPesertaField()">Tambah Peserta</button><br><br>
    <input type="submit" value="Submit">
  </form>

  <!-- Toast Notification -->
  <div id="toast"></div>

  <script>
let pesertaCount = 0;
    let sekolahList = [];

    // Fungsi menampilkan toast
    function showToast(message) {
      const toast = document.getElementById("toast");
      toast.textContent = message;
      toast.className = "show";
      setTimeout(() => {
        toast.className = toast.className.replace("show", "");
      }, 3000);
    }

    // Fungsi validasi input angka dan tampilkan peringatan jika gagal
    function validateNumberInput(inputElem, errorMessage) {
      inputElem.addEventListener("input", () => {
        const val = inputElem.value;
        if (val !== "" && !/^\d*$/.test(val)) {
          showToast(errorMessage);
          // hapus karakter terakhir yang bukan angka
          inputElem.value = val.replace(/\D/g, "");
        }
      });
    }

    // Fungsi autocomplete untuk nama sekolah
    function autocomplete(input) {
      closeAllLists();
      if (!input.value) return false;
      const val = input.value.toLowerCase();

      // buat container autocomplete
      const listDiv = document.createElement("div");
      listDiv.setAttribute("id", input.id + "-autocomplete-list");
      listDiv.setAttribute("class", "autocomplete-items");
      input.parentNode.appendChild(listDiv);

      // Filter sekolah yang cocok
      const matches = sekolahList.filter(school => 
        school.toLowerCase().includes(val)
      );

      // Tampilkan maksimal 5 rekomendasi
      const maxSuggestions = 5;
      const suggestions = matches.slice(0, maxSuggestions);

      if (suggestions.length === 0) {
        listDiv.innerHTML = '';
        return;
      }

      suggestions.forEach((school) => {
        const itemDiv = document.createElement("div");
        // Highlight bagian yang match
        const matchIndex = school.toLowerCase().indexOf(val);
        const beforeMatch = school.substring(0, matchIndex);
        const matchText = school.substring(matchIndex, matchIndex + val.length);
        const afterMatch = school.substring(matchIndex + val.length);
        
        itemDiv.innerHTML = `${beforeMatch}<strong>${matchText}</strong>${afterMatch}`;
        itemDiv.addEventListener("click", function() {
          input.value = school;
          closeAllLists();
        });
        listDiv.appendChild(itemDiv);
      });
    }

    function closeAllLists(elmnt) {
      const items = document.querySelectorAll(".autocomplete-items");
      items.forEach(item => {
        if (elmnt !== item && elmnt !== item.previousSibling) {
          item.parentNode.removeChild(item);
        }
      });
    }

    document.addEventListener("click", function (e) {
      closeAllLists(e.target);
    });

    // Tambah peserta baru
    function addPesertaField() {
      pesertaCount++;
      const container = document.getElementById("pesertaContainer");

      const section = document.createElement("div");
      section.classList.add("peserta-section");
      section.setAttribute("id", `peserta-${pesertaCount}`);
      section.style.position = "relative"; // agar autocomplete dropdown benar posisi

      section.innerHTML = `
        <label for="nama-${pesertaCount}">Nama:</label>
        <input type="text" name="nama[]" id="nama-${pesertaCount}" required>

        <label for="nis-${pesertaCount}">NIS:</label>
        <input type="text" name="nis[]" id="nis-${pesertaCount}" required>

        <label for="tanggal_lahir-${pesertaCount}">Tanggal Lahir:</label>
        <input type="date" name="tanggal_lahir[]" id="tanggal_lahir-${pesertaCount}" required>

        <label for="kelas-${pesertaCount}">Kelas:</label>
        <input type="text" name="kelas[]" id="kelas-${pesertaCount}" required>

        <label for="asal_sekolah-${pesertaCount}">Asal Sekolah:</label>
        <input type="text" name="asal_sekolah[]" id="asal_sekolah-${pesertaCount}" class="sekolah-autocomplete" required>

        <button type="button" class="remove-btn" onclick="removePesertaField(${pesertaCount})">Hapus</button>
      `;

      container.appendChild(section);

      // Pasang validasi angka untuk NIS dan kelas peserta baru
      const nisInput = section.querySelector(`input[name="nis[]"]`);
      validateNumberInput(nisInput, "NIS harus berupa angka!");

      const kelasInput = section.querySelector(`input[name="kelas[]"]`);
      validateNumberInput(kelasInput, "Kelas harus berupa angka!");

      // Pasang autocomplete untuk sekolah
      const sekolahInput = section.querySelector(".sekolah-autocomplete");
      sekolahInput.addEventListener("input", function() {
        autocomplete(this);
      });
      
      // Simpan nilai sekolah saat input berubah
      sekolahInput.addEventListener("change", function() {
        const value = this.value.trim();
        if (value && !sekolahList.includes(value)) {
          sekolahList.push(value);
        }
      });
    }

    // Hapus peserta
    function removePesertaField(id) {
      const section = document.getElementById(`peserta-${id}`);
      if (section) {
        section.remove();
        // Reset ID dan update atribut peserta yang tersisa supaya tetap berurutan
        const allSections = document.querySelectorAll(".peserta-section");
        pesertaCount = 0;
        allSections.forEach((sec) => {
          pesertaCount++;
          sec.setAttribute("id", `peserta-${pesertaCount}`);

          sec.querySelector(`input[name="nama[]"]`).id = `nama-${pesertaCount}`;
          sec.querySelector(`label[for^="nama-"]`).setAttribute("for", `nama-${pesertaCount}`);

          sec.querySelector(`input[name="nis[]"]`).id = `nis-${pesertaCount}`;
          sec.querySelector(`label[for^="nis-"]`).setAttribute("for", `nis-${pesertaCount}`);

          sec.querySelector(`input[name="tanggal_lahir[]"]`).id = `tanggal_lahir-${pesertaCount}`;
          sec.querySelector(`label[for^="tanggal_lahir-"]`).setAttribute("for", `tanggal_lahir-${pesertaCount}`);

          sec.querySelector(`input[name="kelas[]"]`).id = `kelas-${pesertaCount}`;
          sec.querySelector(`label[for^="kelas-"]`).setAttribute("for", `kelas-${pesertaCount}`);

          sec.querySelector(`input[name="asal_sekolah[]"]`).id = `asal_sekolah-${pesertaCount}`;
          sec.querySelector(`label[for^="asal_sekolah-"]`).setAttribute("for", `asal_sekolah-${pesertaCount}`);

          sec.querySelector(".remove-btn").setAttribute("onclick", `removePesertaField(${pesertaCount})`);
        });
      }
    }

    // Pasang validasi untuk kontak pendamping (hanya angka)
    const kontakPendampingInput = document.getElementById("kontak_pendamping");
    validateNumberInput(kontakPendampingInput, "Kontak Pendamping harus berupa angka!");

    // Tambah peserta awal agar tidak kosong
    addPesertaField();

    // Submit form
    document.getElementById("contestForm").addEventListener("submit", function(e) {
      e.preventDefault();

      const form = e.target;

      const namaPendamping = form.nama_pendamping.value.trim();
      const kontakPendamping = form.kontak_pendamping.value.trim();

      // Validasi kontak pendamping wajib angka
      if (!/^\d+$/.test(kontakPendamping)) {
        showToast("Kontak Pendamping harus berupa angka!");
        return;
      }

      const pesertaSections = document.querySelectorAll(".peserta-section");
      if (pesertaSections.length === 0) {
        showToast("Minimal satu peserta harus diisi!");
        return;
      }

      // Simpan sekolah yang baru diinput ke array sekolahList (tanpa duplikat)
      pesertaSections.forEach(section => {
        const sekolahVal = section.querySelector(`input[name="asal_sekolah[]"]`).value.trim();
        if (sekolahVal && !sekolahList.includes(sekolahVal)) {
          sekolahList.push(sekolahVal);
        }
      });

      const submitPromises = [];

      // Loop tiap peserta dan submit satu per satu ke Google Sheets
      for (let i = 0; i < pesertaSections.length; i++) {
        const section = pesertaSections[i];

        const nama = section.querySelector(`input[name="nama[]"]`).value.trim();
        const nis = section.querySelector(`input[name="nis[]"]`).value.trim();
        const tanggalLahir = section.querySelector(`input[name="tanggal_lahir[]"]`).value;
        const kelas = section.querySelector(`input[name="kelas[]"]`).value.trim();
        const sekolah = section.querySelector(`input[name="asal_sekolah[]"]`).value.trim();

        // Validasi lengkap
        if (!nama || !nis || !tanggalLahir || !kelas || !sekolah) {
          showToast(`Data peserta ke-${i + 1} belum lengkap.`);
          return;
        }

        // Validasi angka untuk nis dan kelas
        if (!/^\d+$/.test(nis)) {
          showToast(`NIS peserta ke-${i + 1} harus berupa angka!`);
          return;
        }
        if (!/^\d+$/.test(kelas)) {
          showToast(`Kelas peserta ke-${i + 1} harus berupa angka!`);
          return;
        }

        const rayon = form.querySelector("#rayon").value;

        const formData = new FormData();
        formData.append("nama_pendamping", namaPendamping);
        formData.append("kontak_pendamping", kontakPendamping);
        formData.append("nama", nama);
        formData.append("nis", nis);
        formData.append("tanggal_lahir", tanggalLahir);
        formData.append("kelas", kelas);
        formData.append("asal_sekolah", sekolah);
        formData.append("rayon", rayon);

        // Kirim ke Google Apps Script
        submitPromises.push(
          fetch("https://script.google.com/macros/s/AKfycby9v1MYf34qHg47iMfMqrsLv0RGI5z_RZfchBO80YmzIoimbWoz8enJZnL1E3Wx9Cc/exec", {
            method: "POST",
            body: formData
          })
        );
      }

      Promise.all(submitPromises)
        .then(() => {
          showToast("Semua peserta berhasil dikirim!");
          form.reset();
          document.getElementById("pesertaContainer").innerHTML = "";
          pesertaCount = 0;
          addPesertaField();  // tambah peserta baru kosong setelah submit
        })
        .catch(error => {
          console.error(error);
          showToast("Gagal mengirim beberapa data.");
        });
    });
  </script>
</body>
</html>
